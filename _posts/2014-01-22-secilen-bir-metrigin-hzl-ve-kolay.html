---
layout: post
title: Seçilen bir metriğin hızlı ve kolay olarak distinct count değerini alma
date: '2014-01-22T03:57:00.004+02:00'
author: İbrahim YILDIZ
tags: 
modified_time: '2014-01-22T04:00:59.520+02:00'
thumbnail: http://2.bp.blogspot.com/-VYj7nqJuZlw/Ut8lOsP6ThI/AAAAAAAACEw/2LrWKxYvSzM/s72-c/bitmap_population_count.png
blogger_id: tag:blogger.com,1999:blog-2574404706234424211.post-298000592852489831
blogger_orig_url: http://yildizib.blogspot.com/2014/01/secilen-bir-metrigin-hzl-ve-kolay.html
---

<div style="font-family: Helvetica; font-size: 16px;"><br /></div><div style="font-family: Helvetica; font-size: 12px;">Elimizde bir örnek ile başlamak daha anlaşılır olacaktır. Problemimiz log dosyalarından okunan IP verilerinin distinct count işleminin yapılması, diğer bir tabir ile unique ip’lerin sayılması olsun.</div><div style="font-family: Helvetica; font-size: 12px; min-height: 14px;"><br /></div><div style="font-family: Helvetica; font-size: 12px;">Bu problem oluşturur mu diye sorabilirsiniz. Eğer onlarca sunucunuz var ve onların loglarından bu değeri olmaya kalkarsanız, burada yüz milyonlarca satır logdan bahsediyorum, her bir IP değerini tek tek elinizdeki distinct olarak tutuğunuz IP listeniz ile karşılaştıracaksınız demektir. Bu unique ip listesinin bir üst sınırı var mıdır? Varsa ne kadardır?&nbsp;</div><div style="font-family: Helvetica; font-size: 12px; min-height: 14px;"><br /></div><div style="font-family: Helvetica; font-size: 12px;">Şimdi elimizde olan unique ip listesinin üst sınırını bulamasak da ne kadar hafızaya mal olabileceğini tahmin etmeye çalışalım. Örneğin 100M unique ip listesi oluşturabiliyoruz diyelim günde. Ve iki durumda bu ip değerini sakladığımı varsayalım; birincisi ip değerlerini STRING olsun, diğeri ise INTEGER olsun. Eğer STRING olarak saklayacak ise her ip değeri için “4x3 + 3” maximum karakter , “4x1 + 3” ise alabileceği minimum karakter sayısı olacaktır. Biz maximum değer üzerinden gidersek, bize her ip değeri için 15 karakter yani 15 byte değerinde hafızada yere mal olacaktır.&nbsp;</div><div style="font-family: Helvetica; font-size: 12px; min-height: 14px;"><br /></div><div style="font-family: Helvetica; font-size: 12px;">100.000.000 x 15 = 1.5 x 10^9 byte edecektir. Bu da yaklaşık 1,40 GB hafıza alnına denk gelecektir.</div><div style="font-family: Helvetica; font-size: 12px; min-height: 14px;"><br /></div><div style="font-family: Helvetica; font-size: 12px;">Tabii bunların arasında bir ip değeri için 100M luk liste içinde var mıdır diye her defasında kontrol etmek ise ek olarak bir CPU maliyeti olarak karşınıza çıkacaktır.</div><div style="font-family: Helvetica; font-size: 12px; min-height: 14px;"><br /></div><div style="font-family: Helvetica; font-size: 12px; min-height: 14px;"><br /></div><div style="font-family: Helvetica; font-size: 12px;">Şimdi bir de her ip değerinin INTEGER olarak karşılığını bulduğumuzu ve onu kıyaslamak için sakladığımızı varsayalım. Burada integer 32-bit değerden oluşuyor ise 4 bytelık bir yer kaplayacaktır.</div><div style="font-family: Helvetica; font-size: 12px;">Buna göre bir ip adresi mininum veya maximumu gözetmeye gerek kalmadan 4 bytelık bir alanı kaplayacağını da söyleyebiliriz. String olarak saklamaktan daha iyi olduğu aşikar.</div><div style="font-family: Helvetica; font-size: 12px; min-height: 14px;"><br /></div><div style="font-family: Helvetica; font-size: 12px;">100.000.000 x 4 = 4 x 10^8&nbsp; byte edecektir. Bu da 372 MB yer kaplayacak demek olacaktır. Şimdiden 3/4 oranında yerden kazandık. Ve CPU maliyetine de String değerine göre azalmış varsayabiliriz.&nbsp;</div><div style="font-family: Helvetica; font-size: 12px; min-height: 14px;"><br /></div><div style="font-family: Helvetica; font-size: 12px;">Şimdi bunlar ilk akla gelen çözümler ve bu çözümlerin problemi üst sınırlarının kestirilememesi. Bu şu an bizim için bir problem oluşturmayabilir. Ama yinede işin içine daha zarif bir çözüm sokmak güzel olacaktır.</div><div style="font-family: Helvetica; font-size: 12px; min-height: 14px;"><br /></div><div style="font-family: Helvetica; font-size: 12px;">Üçüncü olarak ise BITMAP çözümüyle yapmaya çalışalım. Önce bunu nasıl yapacağız açıklayayım; elimizde hafıza alanı olsun ve bu hafıza alanına yalnızca 0 veya 1 değerleri yazabilelim. Yani sadece bir bit yazma hakkımız olsun. Ve bu hafıza alanını istediğimiz gibi genişletebilelim de. Şimdi ip lerin integer değerlerini hafıza alanındaki dizide sıra numarası gibi kullanalım. Ve o sıranumarasına denk gelen alanı 1 yapalım. Hepsi bu kadar. Elimizde her unique ip değeri için 1 bit artan bir şey olacaktır artık.&nbsp;</div><div style="font-family: Helvetica; font-size: 12px; min-height: 14px;"><br /></div><div style="font-family: Helvetica; font-size: 12px; min-height: 14px;"><br /></div><div style="font-family: Helvetica; font-size: 12px;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-VYj7nqJuZlw/Ut8lOsP6ThI/AAAAAAAACEw/2LrWKxYvSzM/s1600/bitmap_population_count.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-VYj7nqJuZlw/Ut8lOsP6ThI/AAAAAAAACEw/2LrWKxYvSzM/s1600/bitmap_population_count.png" /></a></div><div style="font-family: Helvetica; font-size: 12px; min-height: 14px;"><br /></div><div style="font-family: Helvetica; font-size: 12px; min-height: 14px;"><br /></div><div style="font-family: Helvetica; font-size: 12px; min-height: 14px;"><br /></div><div style="font-family: Helvetica; font-size: 12px;">Şimdi eğer aynı ip adresi elimizde var mı diye kontrol etmek de basitleşecektir. Eğer ip nin integer değeri sıra noyu (offset) gösteriyorsa, o sıra nodaki bit 1 ise var demektir. Yok ise 1 yapmamız yeterlidir. Ancak bunu kontrol etmemize bile gerek yok. Direk ve her seferinde 1 yapmak yeterli olacaktır. Bu CPU maliyetini de en aza indirecektir.&nbsp;</div><div style="font-family: Helvetica; font-size: 12px; min-height: 14px;"><br /></div><div style="font-family: Helvetica; font-size: 12px; min-height: 14px;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-dVr04AWD--8/Ut8lYwPUYUI/AAAAAAAACE4/NpgcJJIePWI/s1600/unique_users.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-dVr04AWD--8/Ut8lYwPUYUI/AAAAAAAACE4/NpgcJJIePWI/s1600/unique_users.png" /></a></div><div style="font-family: Helvetica; font-size: 12px; min-height: 14px;"><br /></div><div style="font-family: Helvetica; font-size: 12px;"></div><div style="font-family: Helvetica; font-size: 12px; min-height: 14px;"><br /></div><div style="font-family: Helvetica; font-size: 12px;">Sonrasında ise unique ip sayısı elimizde 1 olan bitlerin sayısı kadar olacaktır. Hepsi bu kadar.</div><div style="font-family: Helvetica; font-size: 12px; min-height: 14px;"><br /></div><div style="font-family: Arial; font-size: 12px;"><span style="font-family: Helvetica;">Burada sınır integer değeri olacaktır. en büyük ip değeri “<b>255.255.255.255</b>” olacaktır. Onun integer değeri ise </span><b>4294967295</b> dir ve 4294967295 adet bit demektir. Bu yaklaşık <b>500</b> MB hafıza demektir. Bundan daha fazla hafıza alanına ihtiyacınız olmayacaktır.&nbsp;</div><div style="font-family: Arial; font-size: 12px; min-height: 14px;"><br /></div><div style="font-family: Arial; font-size: 12px;">Yani sitenizin trafiğinden bağımsız olarak, distinct count almak için 500MB bir ortak hafıza alanından&nbsp;</div><div style="font-family: Arial; font-size: 12px;">daha büyük bir yere ihtiyaç olmadan böyle bir sayımı gerçekleştirebileceğiz.</div><div style="font-family: Arial; font-size: 12px; min-height: 14px;"><br /></div><div style="font-family: Helvetica; font-size: 12px;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-vSF-2vqN3QE/Ut8lgNyNWDI/AAAAAAAACFA/FQxU_ieop0E/s1600/union.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-vSF-2vqN3QE/Ut8lgNyNWDI/AAAAAAAACFA/FQxU_ieop0E/s1600/union.png" /></a></div><div style="font-family: Arial; font-size: 12px; min-height: 14px;"><br /></div><div style="font-family: Arial; font-size: 12px; min-height: 14px;"><br /></div><div style="font-family: Arial; font-size: 12px;">Detaylar yine kullanıma göre değişecektir. Mesela bu değeri günlük tutarsanız, <b>500 MB / gün</b>&nbsp; şeklinde bir yere ihtiyacınız olacaktır. Bu öngörülebilir bir değerdir.</div><div style="font-family: Arial; font-size: 12px; min-height: 14px;"><br /></div><div style="font-family: Arial; font-size: 12px; min-height: 14px;"><br /></div><div style="font-family: Arial; font-size: 12px;"><b>Java</b>’da bu konuda yardım edebilecek bir sınıf ise mevcut. Adı ise <b>Bitset</b> . Burada bitset nesnesinde bir offset değerini yani sıranolu alanı 1 ya da 0 yapabilirsiniz. Sonrasonda ise <b>cardinality</b>() fonsiyonunu çağırdığınızda ise size 1 olan alanların sayısını yani istediğiniz sayıyı verecektir.</div><div style="font-family: Arial; font-size: 12px; min-height: 14px;"><br /></div><div style="font-family: Arial; font-size: 12px; min-height: 14px;"><br /></div><div style="font-family: Arial; font-size: 12px;">Burada ip değeri değilde herhangi bir metriği ölçebilirdik. Peki nasıl yapabilirdik bunu? <span style="text-decoration: underline;"><i>Bir nesneye atadığımız bu değerin unique </i><b><i>hashcode</i></b><i> üretmesini ve her aynı değer için aynı </i><b><i>hashcode</i></b><i> değerini vermesini sağlayabilirsek</i></span>, herhangi bir metriği distinct count yapabiliriz en az zahmet ve maliyetle…</div><div style="font-family: Arial; font-size: 12px; min-height: 14px;"><br /></div><div style="font-family: Arial; font-size: 12px; min-height: 14px;"><br /></div><div style="font-family: Helvetica; font-size: 12px; min-height: 14px;"><b>NOT</b>:<br />-------</div><div style="font-family: Helvetica; font-size: 12px; min-height: 14px;"><b></b>Ayrıca doküman olarak da&nbsp;<a href="https://docs.google.com/file/d/0B6VVOcLV9AwHMzlVR1hlYWZEajg/edit?pli=1" target="_blank">buradan</a>&nbsp;görüntüleyebilir veya indirebilirsiniz.<br /><br /></div><div style="font-family: Helvetica; font-size: 12px;"><b>Kaynaklar</b>:</div><div style="font-family: Helvetica; font-size: 12px;">———————</div><div style="font-family: Helvetica; font-size: 12px;">1- http://highscalability.com/blog/2012/4/5/big-data-counting-how-to-count-a-billion-distinct-objects-us.html&nbsp;</div><div style="font-family: Helvetica; font-size: 12px;">2- http://blog.getspool.com/2011/11/29/fast-easy-realtime-metrics-using-redis-bitmaps/&nbsp;</div><div style="font-family: Helvetica; font-size: 12px;">3- http://docs.oracle.com/javase/7/docs/api/java/util/BitSet.html<br /><br /></div>